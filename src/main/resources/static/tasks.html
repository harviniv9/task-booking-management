<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tasks</title>
    <style>
        body { font-family: system-ui, Arial; margin: 24px; }

        .topbar {
          display:flex;
          align-items:center;
          gap:12px;
          flex-wrap: wrap;
          margin-bottom: 16px;
        }
        .spacer { flex: 1; }

        .btnLink {
          display:inline-block;
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 8px;
          background: #fff;
          text-decoration:none;
          color:#0066cc;
        }
        .btnLink:hover { background:#f6f6f6; }

        .logoutBtn, .applyBtn {
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 8px;
          background:#fff;
          cursor:pointer;
        }
        .logoutBtn:hover, .applyBtn:hover { background:#f6f6f6; }

        .controls {
          display: flex;
          gap: 12px;
          align-items: end;
          flex-wrap: wrap;
          margin-bottom: 16px;
          padding: 12px;
          border: 1px solid #eee;
          border-radius: 12px;
          background: #fafafa;
        }

        label { display:flex; flex-direction: column; gap:6px; font-size: 13px; color:#333; }
        select {
          padding: 10px 12px;
          border: 1px solid #ccc;
          border-radius: 10px;
          background: #fff;
          min-width: 220px;
        }
        select:focus {
          outline: none;
          border-color: #0066cc;
          box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.12);
        }

        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f6f6f6; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 12px; border: 1px solid #ccc; }
        .actions button { margin-right: 8px; padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd; background:#fff; cursor:pointer; }
        .actions button:hover { background:#f6f6f6; }
    </style>
</head>

<body>
<div class="topbar">
    <h1 style="margin:0;">Tasks</h1>
    <div id="meBox">Loading user...</div>

    <div class="spacer"></div>

    <a class="btnLink" href="/dashboard.html">Dashboard</a>
    <a class="btnLink" href="/create-task.html">Create Task</a>

    <form action="/logout" method="post" style="margin:0;">
        <button class="logoutBtn" type="submit">Logout</button>
    </form>
</div>

<!-- Required features: Status filter + Task Date/Time sort -->
<div class="controls">
    <label>
        Filter by Status
        <select id="statusFilter">
            <option value="">All</option>
            <option value="PENDING">Pending</option>
            <option value="APPROVED">Approved</option>
            <option value="REJECTED">Rejected</option>
        </select>
    </label>

    <label>
        Task Date/Time Sort
        <select id="dateSortDir">
            <option value="asc">Oldest → Newest</option>
            <option value="desc">Newest → Oldest</option>
        </select>
    </label>

    <button class="applyBtn" id="applyBtn" type="button">Apply</button>
    <button class="applyBtn" type="button" id="exportCsvBtn">Export CSV</button>

</div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Task Date/Time</th>
        <th>Assigned</th>
        <th>Created By</th>
        <th>Decision</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="tasksTbody"></tbody>
</table>

<script>
    let me = null;

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${text}`);
      }
      return res.json();
    }

    function badge(text) {
      return `<span class="badge">${text ?? ""}</span>`;
    }

    function applyQueryParamsToControls() {
      const params = new URLSearchParams(window.location.search);

      const status = params.get("status");
      const sortDir = params.get("sortDir");

      if (status !== null) document.getElementById("statusFilter").value = status;
      if (sortDir !== null) document.getElementById("dateSortDir").value = sortDir;
    }

    function buildApiUrlAndSyncUrl() {
      const status = document.getElementById("statusFilter").value;
      const sortDir = document.getElementById("dateSortDir").value;

      // Sort is always by taskDateTime (requirement)
      const params = new URLSearchParams();
      if (status) params.set("status", status);
      params.set("sortBy", "taskDateTime");
      params.set("sortDir", sortDir);

      // Keep browser URL in sync (bookmark-friendly)
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.replaceState({}, "", newUrl);

      return `/api/tasks?${params.toString()}`;
    }

    async function loadMe() {
      me = await fetchJson("/api/me");
      document.getElementById("meBox").innerHTML =
        `Logged in as <b>${me.username}</b> (${me.role})`;
    }

    async function loadTasks() {
      const url = buildApiUrlAndSyncUrl();
      const tasks = await fetchJson(url);

      const tbody = document.getElementById("tasksTbody");
      tbody.innerHTML = "";

      tasks.forEach(t => {
        const canDecide = me && (me.role === "MANAGER") && t.status === "PENDING";

        const decisionInfo = t.decisionByUsername
          ? `${t.decisionByUsername} @ ${t.decisionAt}`
          : "";

        const actionsHtml = canDecide
          ? `<div class="actions">
               <button onclick="decide(${t.id}, 'APPROVE')">Approve</button>
               <button onclick="decide(${t.id}, 'REJECT')">Reject</button>
             </div>`
          : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.id}</td>
          <td>${t.title}</td>
          <td>${badge(t.status)}</td>
          <td>${badge(t.priority)}</td>
          <td>${t.taskDateTime ?? ""}</td>
          <td>${t.assignedUsername ?? ""}</td>
          <td>${t.createdByUsername ?? ""}</td>
          <td>${decisionInfo}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function decide(id, decision) {
      try {
        await fetchJson(`/api/tasks/${id}/approve`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ decision })
        });
        await loadTasks();
      } catch (e) {
        alert("Decision failed: " + e.message);
      }
    }

    window.decide = decide;

    document.getElementById("applyBtn").addEventListener("click", loadTasks);


    // nice UX: auto apply
    document.getElementById("statusFilter").addEventListener("change", loadTasks);
    document.getElementById("dateSortDir").addEventListener("change", loadTasks);

    document.getElementById("exportCsvBtn").addEventListener("click", () => {
      const status = document.getElementById("statusFilter").value;
      const sortDir = document.getElementById("dateSortDir").value;

      const params = new URLSearchParams();
      if (status) params.set("status", status);
      params.set("sortBy", "taskDateTime");
      params.set("sortDir", sortDir);

      window.location.href = "/api/tasks/export?" + params.toString();
    });


    (async function init() {
      try {
        applyQueryParamsToControls();
        await loadMe();
        await loadMe();
        await loadTasks();
      } catch (e) {
        document.body.innerHTML = `
          <h2>You are not logged in</h2>
          <p>Please <a href="/login.html">login</a> and refresh.</p>
          <pre>${e.message}</pre>
        `;
      }
    })();
</script>
</body>
</html>
<!doctype html>