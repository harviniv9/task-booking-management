<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar</title>
  <style>
    :root{
      --bg1:#0ea5e9;   /* sky */
      --bg2:#6366f1;   /* indigo */
      --card:#ffffffcc;
      --cardBorder:#ffffff55;
      --text:#0f172a;  /* slate-900 */
      --muted:#475569; /* slate-600 */
      --shadow: 0 18px 55px rgba(2, 6, 23, .20);
      --radius: 18px;
      --ring:#60a5fa;

      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;

      --line: rgba(15,23,42,.10);
      --line2: rgba(255,255,255,.22);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      padding: 26px;

      background:
        radial-gradient(1200px 650px at 12% 10%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1000px 520px at 90% 18%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .container{
      max-width: 1180px;
      margin: 0 auto;
    }

    /* ---------- Top Bar ---------- */
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .titleBlock{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .logo{
      width:44px;
      height:44px;
      border-radius:16px;
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:800;
      letter-spacing:.4px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.30);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 26px rgba(2,6,23,.18);
      user-select:none;
    }

    h1{
      margin:0;
      font-size: 24px;
      letter-spacing:-0.02em;
      color:#fff;
      line-height:1.1;
    }

    .subtitle{
      margin:2px 0 0 0;
      font-size: 13px;
      color: rgba(255,255,255,.86);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.26);
      color:#fff;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(2,6,23,.12);
      font-size: 13px;
      line-height: 1;
      white-space:nowrap;
    }
    .pillDot{
      width:9px; height:9px;
      border-radius: 999px;
      background: rgba(16,185,129,.95);
      box-shadow: 0 0 0 4px rgba(16,185,129,.20);
      flex:0 0 auto;
    }

    .spacer{ flex: 1; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.32);
      background: rgba(255,255,255,.16);
      color:#fff;
      text-decoration:none;
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .06s ease, filter .15s ease, background .15s ease;
      box-shadow: 0 10px 22px rgba(2,6,23,.14);
      font-size: 13px;
      font-weight: 650;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.05); background: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      border-color: rgba(255,255,255,.45);
      background: rgba(255,255,255,.22);
    }

    .btnIcon{ width:16px; height:16px; opacity:.92; }

    /* ---------- Shell ---------- */
    .shell{
      border-radius: var(--radius);
      background: rgba(255,255,255,.12);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .shellHeader{
      padding: 18px 18px 0 18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .shellHeader h2{
      margin:0;
      color:#fff;
      font-size: 16px;
      font-weight: 850;
      letter-spacing:-0.01em;
    }
    .shellHeader p{
      margin: 6px 0 0 0;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height:1.4;
      max-width: 76ch;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.20);
      margin: 16px 0;
    }

    /* ---------- Controls ---------- */
    .controls{
      margin: 0 18px 14px 18px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      box-shadow: 0 14px 34px rgba(2,6,23,.14);
      overflow:hidden;
      position:relative;
    }
    .controls:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(650px 260px at 18% 0%, rgba(255,255,255,.45), transparent 55%);
      pointer-events:none;
    }
    .controlsInner{
      position:relative;
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:end;
      flex-wrap:wrap;
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .01em;
      min-width: 240px;
    }

    .field{
      position:relative;
      width: 100%;
    }

    select{
      width: 100%;
      padding: 12px 42px 12px 42px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.85);
      font-size: 14px;
      line-height: 1.4;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
      appearance:none;
    }
    select:focus{
      border-color: rgba(96,165,250,.8);
      box-shadow: 0 0 0 4px rgba(96,165,250,.28);
    }

    .icon{
      position:absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      opacity: .55;
      pointer-events:none;
    }
    .chev{
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      opacity: .55;
      pointer-events:none;
    }

    .navBtn{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 850;
      font-size: 13px;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(14,165,233,1));
      box-shadow: 0 10px 24px rgba(2,6,23,.20);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      white-space:nowrap;
    }
    .navBtn:hover{ filter: brightness(1.03); box-shadow: 0 14px 30px rgba(2,6,23,.26); }
    .navBtn:active{ transform: translateY(1px); }

    .ghostBtn{
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 850;
      font-size: 13px;
      cursor:pointer;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.72);
      color: #0f172a;
      transition: transform .06s ease, filter .15s ease, background .15s ease;
      white-space:nowrap;
    }
    .ghostBtn:hover{ filter: brightness(1.02); background: rgba(255,255,255,.86); }
    .ghostBtn:active{ transform: translateY(1px); }

    /* ---------- Month Header ---------- */
    .monthHeader{
      margin: 0 18px 14px 18px;
      display:flex;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
    }

    .monthTitle{
      flex: 1;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:-0.02em;
      color:#fff;
      text-align:center;
      min-width: 220px;
    }

    /* ---------- Calendar Grid ---------- */
    .dowGrid, .calGrid{
      margin: 0 18px 18px 18px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    .dow{
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      color: rgba(255,255,255,.9);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.06em;
      text-transform: uppercase;
      text-align:center;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(2,6,23,.10);
    }

    .cell{
      min-height: 120px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--cardBorder);
      box-shadow: 0 14px 34px rgba(2,6,23,.12);
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      overflow:hidden;
      position:relative;
      cursor: default;
      transition: transform .10s ease, box-shadow .15s ease, filter .15s ease;
    }
    .cell:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 44px rgba(2,6,23,.16);
      filter: brightness(1.01);
    }

    .cell:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(520px 180px at 18% 0%, rgba(255,255,255,.42), transparent 55%);
      pointer-events:none;
    }

    .cell.muted{
      background: rgba(255,255,255,.55);
      color: rgba(71,85,105,.9);
      border-color: rgba(255,255,255,.35);
      opacity: .78;
    }

    .dayNum{
      position:relative;
      display:flex;
      justify-content: space-between;
      align-items:center;
      font-size: 12px;
      font-weight: 900;
      color:#111827;
    }

    .todayRing{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(96,165,250,.16);
      border: 1px solid rgba(96,165,250,.40);
      box-shadow: 0 0 0 4px rgba(96,165,250,.18);
      font-weight: 900;
    }

    .pill{
      position:relative;
      font-size: 11px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255,255,255,.74);
      color:#111827;
      font-weight: 800;
      white-space:nowrap;
    }

    .taskItem{
      position:relative;
      font-size: 12px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(255,255,255,.78);
      cursor: pointer;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: transform .06s ease, filter .15s ease, background .15s ease;
    }
    .taskItem:hover{ filter: brightness(1.02); background: rgba(255,255,255,.92); }
    .taskItem:active{ transform: translateY(1px); }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:7px;
      margin-right: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      font-size: 11px;
      font-weight: 900;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,.18);
      flex:0 0 auto;
    }
    .dotPending{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.18); }
    .dotApproved{ background: var(--ok); box-shadow: 0 0 0 3px rgba(16,185,129,.18); }
    .dotRejected{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    /* ---------- Modal ---------- */
    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      backdrop-filter: blur(6px);
    }

    .modal{
      width: min(860px, 96vw);
      background: rgba(255,255,255,.90);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: 0 24px 70px rgba(2,6,23,.35);
      overflow:hidden;
    }

    .modalHeader{
      padding: 14px 14px 12px 14px;
      display:flex;
      align-items:center;
      gap: 12px;
      background: rgba(255,255,255,.70);
      border-bottom: 1px solid rgba(15,23,42,.10);
    }

    .modalTitle{
      font-weight: 950;
      letter-spacing:-0.015em;
    }

    .closeBtn{
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.75);
      color: #0f172a;
      transition: transform .06s ease, filter .15s ease, background .15s ease;
      white-space:nowrap;
    }
    .closeBtn:hover{ filter: brightness(1.02); background: rgba(255,255,255,.92); }
    .closeBtn:active{ transform: translateY(1px); }

    .modalBody{
      padding: 14px;
      overflow:auto;
      max-height: min(70vh, 620px);
    }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 740px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      overflow:hidden;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(255,255,255,.88);
      border-bottom: 1px solid rgba(15,23,42,.10);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      text-align:left;
      font-size: 13px;
      white-space: nowrap;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.92);
    }
    tbody td:nth-child(2){
      max-width: 340px;
      overflow:hidden;
      text-overflow: ellipsis;
      font-weight: 800;
      color:#111827;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      font-size: 12px;
      font-weight: 800;
      color:#111827;
    }

    /* ---------- Small screens ---------- */
    @media (max-width: 720px){
      .dowGrid, .calGrid{ gap: 8px; }
      .cell{ min-height: 106px; }
      label{ min-width: 100%; }
      .monthTitle{ text-align:left; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
    }
  </style>
</head>
<body>

<div class="container">

  <div class="topbar">
    <div class="titleBlock">
      <div class="logo">TB</div>
      <div>
        <h1>Calendar</h1>
        <div class="subtitle">Monthly view of tasks by date/time</div>
      </div>
    </div>

    <div class="pill" title="Current user">
      <span class="pillDot"></span>
      <span id="meBox">Loading user...</span>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <a class="btn" href="/dashboard.html">
        <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 11l8-7 8 7v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M9.5 22v-7h5v7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        Dashboard
      </a>

      <a class="btn" href="/tasks.html">
        <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8 6h12M8 12h12M8 18h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M4 6h.01M4 12h.01M4 18h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
        Tasks
      </a>

      <a class="btn btnPrimary" href="/create-task.html">
        <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        Create Task
      </a>

      <form action="/logout" method="post" style="margin:0;">
        <button class="btn" type="submit" title="Logout">
          <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10 7V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-7a2 2 0 0 1-2-2v-1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M3 12h11" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M7 8l-4 4 4 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Logout
        </button>
      </form>
    </div>
  </div>

  <section class="shell">
    <div class="shellHeader">
      <div>
        <h2>Monthly Calendar</h2>
        <p>Filter by status, jump to today, and click any day with tasks to view details.</p>
      </div>
    </div>

    <div class="divider"></div>

    <div class="controls">
      <div class="controlsInner">
        <label>
          Status
          <div class="field">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 5h16l-6 7v6l-4 1v-7L4 5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
            <select id="statusFilter">
              <option value="">All</option>
              <option value="PENDING">Pending</option>
              <option value="APPROVED">Approved</option>
              <option value="REJECTED">Rejected</option>
            </select>
            <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </label>

        <button class="navBtn" id="todayBtn" type="button">Today</button>
      </div>
    </div>

    <div class="monthHeader">
      <button class="ghostBtn" id="prevBtn" type="button">← Prev</button>
      <div class="monthTitle" id="monthTitle">—</div>
      <button class="ghostBtn" id="nextBtn" type="button">Next →</button>
    </div>

    <div class="dowGrid" id="dowRow"></div>
    <div class="calGrid" id="calendarGrid"></div>
  </section>

</div>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle" id="modalTitle">Tasks</div>
      <div class="spacer"></div>
      <button class="closeBtn" id="closeModalBtn" type="button">Close</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  let me = null;
  let currentMonth = new Date(); // today
  currentMonth.setDate(1);

  // Tasks grouped by YYYY-MM-DD
  let tasksByDay = new Map();

  async function fetchJson(url, options = {}) {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function loadMe() {
    me = await fetchJson("/api/me");
    document.getElementById("meBox").innerHTML =
      `Logged in as <b>${me.username}</b> · ${me.role}`;
  }

  function ymd(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function parseTaskDay(task) {
    // task.taskDateTime like "2026-01-20T10:00:00"
    if (!task.taskDateTime) return null;
    return task.taskDateTime.substring(0, 10);
  }

  function badge(text) {
    return `<span class="badge">${text ?? ""}</span>`;
  }

  function statusDot(status){
    if (status === "APPROVED") return "dotApproved";
    if (status === "REJECTED") return "dotRejected";
    return "dotPending";
  }

  async function loadTasksForMonth() {
    const status = document.getElementById("statusFilter").value;

    const params = new URLSearchParams();
    if (status) params.set("status", status);

    // sort by taskDateTime asc so calendar lists tasks in order
    params.set("sortBy", "taskDateTime");
    params.set("sortDir", "asc");

    const tasks = await fetchJson("/api/tasks?" + params.toString());

    tasksByDay = new Map();
    tasks.forEach(t => {
      const day = parseTaskDay(t);
      if (!day) return;
      if (!tasksByDay.has(day)) tasksByDay.set(day, []);
      tasksByDay.get(day).push(t);
    });
  }

  function renderDowRow() {
    const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const el = document.getElementById("dowRow");
    el.innerHTML = "";
    dow.forEach(d => {
      const div = document.createElement("div");
      div.className = "dow";
      div.textContent = d;
      el.appendChild(div);
    });
  }

  function renderCalendar() {
    const title = document.getElementById("monthTitle");
    const monthName = currentMonth.toLocaleString(undefined, { month: "long", year: "numeric" });
    title.textContent = monthName;

    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    const firstDayOfMonth = new Date(currentMonth);
    const startDow = firstDayOfMonth.getDay(); // 0..6

    // Start date shown = Sunday before (or same day) the 1st
    const start = new Date(firstDayOfMonth);
    start.setDate(start.getDate() - startDow);

    const todayKey = ymd(new Date());

    // 6 weeks grid = 42 days
    for (let i = 0; i < 42; i++) {
      const dayDate = new Date(start);
      dayDate.setDate(start.getDate() + i);

      const inThisMonth = dayDate.getMonth() === currentMonth.getMonth();
      const dayKey = ymd(dayDate);

      const cell = document.createElement("div");
      cell.className = "cell" + (inThisMonth ? "" : " muted");

      const dayTasks = tasksByDay.get(dayKey) || [];

      const header = document.createElement("div");
      header.className = "dayNum";

      const dayNumHtml = (dayKey === todayKey)
        ? `<span class="todayRing">${dayDate.getDate()}</span>`
        : `<span>${dayDate.getDate()}</span>`;

      header.innerHTML = `
        ${dayNumHtml}
        ${dayTasks.length ? `<span class="pill">${dayTasks.length} task(s)</span>` : `<span class="pill">—</span>`}
      `;
      cell.appendChild(header);

      // Show up to 3 tasks; if more, show +N more
      const maxShow = 3;
      dayTasks.slice(0, maxShow).forEach(t => {
        const item = document.createElement("div");
        item.className = "taskItem";
        item.innerHTML = `
          <span class="tag"><span class="dot ${statusDot(t.status)}"></span>${t.priority}</span>
          ${t.title}
        `;
        item.onclick = () => openDayModal(dayKey, dayTasks);
        cell.appendChild(item);
      });

      if (dayTasks.length > maxShow) {
        const more = document.createElement("div");
        more.className = "taskItem";
        more.textContent = `+ ${dayTasks.length - maxShow} more...`;
        more.onclick = () => openDayModal(dayKey, dayTasks);
        cell.appendChild(more);
      }

      // Clicking empty day opens modal too (if tasks exist)
      cell.onclick = (e) => {
        if (e.target.classList.contains("taskItem")) return;
        if (dayTasks.length) openDayModal(dayKey, dayTasks);
      };

      grid.appendChild(cell);
    }
  }

  function openDayModal(dayKey, dayTasks) {
    document.getElementById("modalTitle").textContent = `Tasks on ${dayKey}`;
    const body = document.getElementById("modalBody");

    body.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Time</th>
            <th>Assigned</th>
            <th>Created By</th>
          </tr>
        </thead>
        <tbody>
          ${dayTasks.map(t => `
            <tr>
              <td>${t.id}</td>
              <td title="${(t.title ?? "").replaceAll('"','&quot;')}">${t.title ?? ""}</td>
              <td>${badge(t.status)}</td>
              <td>${badge(t.priority)}</td>
              <td>${t.taskDateTime ? t.taskDateTime.substring(11, 16) : ""}</td>
              <td>${t.assignedUsername ?? ""}</td>
              <td>${t.createdByUsername ?? ""}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    document.getElementById("modalBackdrop").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modalBackdrop").style.display = "none";
  }

  document.getElementById("closeModalBtn").addEventListener("click", closeModal);
  document.getElementById("modalBackdrop").addEventListener("click", (e) => {
    if (e.target.id === "modalBackdrop") closeModal();
  });

  document.getElementById("prevBtn").addEventListener("click", async () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    await refresh();
  });

  document.getElementById("nextBtn").addEventListener("click", async () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    await refresh();
  });

  document.getElementById("todayBtn").addEventListener("click", async () => {
    currentMonth = new Date();
    currentMonth.setDate(1);
    await refresh();
  });

  document.getElementById("statusFilter").addEventListener("change", async () => {
    await refresh();
  });

  async function refresh() {
    await loadTasksForMonth();
    renderCalendar();
  }

  (async function init() {
    try {
      renderDowRow();
      await loadMe();
      await refresh();
    } catch (e) {
      document.body.innerHTML = `
        <div style="max-width:680px;margin:80px auto;color:#fff;font-family:system-ui">
          <h2 style="margin:0 0 10px 0;">Session expired</h2>
          <p style="margin:0 0 16px 0;opacity:.9;">Please sign in again to continue.</p>
          <a href="/login.html" style="display:inline-block;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.28);color:#fff;text-decoration:none;">Go to Login</a>
          <pre style="margin-top:14px;white-space:pre-wrap;opacity:.85;">${e.message}</pre>
        </div>
      `;
    }
  })();
</script>

</body>
</html>
